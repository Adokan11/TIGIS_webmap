<!DOCTYPE html>
<html>
<head>
    <!--meta charset = 'utf-8'-->
    <title>Webmap Dev</title>
    <link rel = 'stylesheet' href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'/>
    <style>
        body {margin:0; font-family: Arial, sans-serif}
        #map {height: 100vh}
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4); max-height: 80vh; overflow-y: auto
        }
        label {display: block; margin: 8px 0; font-weight: bold}
    </style>
</head>
<body>

<!-- Layer control panel (populated by Flask template) -->
<div class = 'controls'>
    <h3>Layers</h3>
    {% for layer in layers %}
    <label>
        <input type = 'checkbox' checked onclick = 'toggle("{{ layer }}")' data-layer = '{{ layer }}'>
        <span class="layer-label" data-layer="{{ layer }}">{{ layer.replace('_', ' ') | title }}</span>
    </label>
    {% endfor %}
</div>

<div id = 'map'></div>

<script src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
<script>

    // Define all layer styles and labels in one place
    const LAYER_CONFIG = {
        buffers: {
            defaultOn: false,
            label: 'Buffers',
            color: '#332288',
            weight: 2,
            fillOpacity: 0.15},
        spaces: {
            defaultOn: false,
            label: 'Green Spaces',
            color: '#117733',
            weight: 2,
            fillOpacity: 0.15},
        sites: {
            defaultOn: true,
            label: 'Sites',
            color: '#882255',
            radius: 5,
            fillOpacity: 0.7},
        ccs: {
            defaultOn: true,
            label: 'Community Centres',
            color: '#999933',
            radius: 5,
            fillOpacity: 0.7}
    }

    // Initialize the map centered on Edinburgh
    const map = L.map('map').setView([55.94, -3.24], 12)

    // Add OpenStreetMap base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy OpenStreetMap contributors'}).addTo(map)
    
    // Create a custom pane for sites with higher z-index
    map.createPane('sitesPane')
    map.getPane('sitesPane').style.zIndex = 650
    
    // Track currently active layers
    const activeLayers = {}

    /**
     * Generate HTML popup content based on layer type
     * @param {Object} properties - Feature properties from GeoJSON
     * @param {string} layerName - Name of the layer
     * @returns {string} HTML string for popup content
     */
    function infoPopup(properties, layerName) {
        if (layerName === 'buffers') {
            return `
                <h3>Buffer of: ${properties.ENT_TITLE}</h3>
                <b>Population in buffer:</b> ${Math.round(properties.Population).toLocaleString()}<br>
                <b>Avg Income:</b> ${Math.round(properties.avg_income).toLocaleString()}<br>
                <b>Avg Employment:</b> ${Math.round(properties.avg_employ).toLocaleString()}<br>
                <b>Health Score:</b> ${Math.round(properties.avg_health).toLocaleString()}<br>
                <b>Access Score:</b> ${Math.round(properties.avg_access).toLocaleString()}<br>
            `
                //<br><b>Designated:</b> ${properties.DESIGNATED}<br>
                //<b>Ref:</b> ${properties.DES_REF} <small>(cat: ${properties.CATEGORY})</small><br>
                //<a href='${properties.LINK}' target='_blank'>https://portal.historicenvironment.scot/</a>
        } else if (layerName === 'spaces'){
            return `
                <h3>${properties.NAME}</h3>
                <b>Category:</b> ${properties.PAN65}<br>
                ${properties.CLASSIFICA ? `<b>Classification:</b> ${properties.CLASSIFICA}<br>` : ''}
                <b>NP Name:</b> ${properties.NP_Name}<br>
                ${properties.YEAROPEN > 1000 ? `<b>Year Opened:</b> ${parseInt(properties.YEAROPEN, 10)}<br>` : ''}
                <b>Area:</b> ${properties.Area_ha.toLocaleString()} hectares <br>
            `
        } else if (layerName === 'sites') {
            return `
                <h3>${properties.ENT_TITLE}</h3>
                <b>Designated:</b> ${properties.DESIGNATED}<br>
                <b>Ref:</b> ${properties.DES_REF}<br>
                <a href='${properties.LINK}' target='_blank'>https://portal.historicenvironment.scot/</a>
            `
        } else if (layerName === 'ccs') {
            return `
                <h3>${properties.CENTRE_NAME}</h3>
                <b>Address:</b> ${properties.ADDRESS}<br>
                ${properties.LISTED ? `<b>Listed:</b> ${properties.LISTED}<br>` : ''}
                ${properties.LINK ? `<a href=${properties.LINK} target='_blank'>Centre Website</a>` : ''}
            `
        } else {
            // fallback for other layers
            // just show everything! and try to make links work
            let html = '<table>'
            for (const [k, v] of Object.entries(properties)) {
                if (v && typeof v === 'string' && v.startsWith('http')) {
                    html += `<tr><th>${k}</th><td><a href='${v}' target='_blank'>Link</a></td></tr>`
                } else {
                    html += `<tr><th>${k}</th><td>${v}</td></tr>`
                }
            }
            return html + '</table>'
        }
    }

    /**
     * Toggle layer visibility on the map
     * @param {string} name - Layer name to toggle
     */
    function toggle(name) {
        if (activeLayers[name]) {
            map.removeLayer(activeLayers[name])
            delete activeLayers[name]
        } else {
            fetch(`/layer/${name}`)
            .then(r => r.json())
            .then(data => {

                // Get style from config
                const style = LAYER_CONFIG[name] || {color: '#3388ff'}
                
                // Create GeoJSON layer with styling and popups
                const layer = L.geoJSON(data, {
                    
                    // fetch style
                    style: style,

                    // Use circle markers for point layers
                    pointToLayer: (feature, latlng) => {
                        if (name === 'sites' || name === 'ccs') {
                            return L.circleMarker(latlng, {
                                ...style,
                                pane: 'sitesPane'
                            })
                        }
                        return L.marker(latlng)
                    },
                    
                    onEachFeature: (feature, layer) => {

                        // Generate popup content
                        const popupContent = infoPopup(feature.properties, name)

                        // Bind popup to feature
                        layer.bindPopup(popupContent, {
                            className: `custom-popup-${name}`,
                        })

                        // Add colored border when popup opens
                        layer.on('popupopen', (e) => {
                            const el = e.popup.getElement()
                            if (el) {
                                el.style.border = `4px solid ${style.color}`
                                el.style.borderRadius = '15px'}
                        });

                    }
                }).addTo(map)

                // Store reference to active layer
                activeLayers[name] = layer
            })
        }
    }

    // Auto-load layers that are defaultOn
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        const layerName = cb.dataset.layer
        if (LAYER_CONFIG[layerName]?.defaultOn) {
            toggle(layerName)
        }
    })

    // Apply custom labels and colors from config
    document.querySelectorAll('.layer-label').forEach(label => {
        const layerName = label.dataset.layer
        const config = LAYER_CONFIG[layerName]
        
        if (config) {
            // Set custom label text
            label.textContent = config.label
            
            // Set text color
            label.style.color = config.color
            label.style.fontWeight = 'bold'

            // Set default checked state
            const checkbox = label.previousElementSibling
            checkbox.checked = config.defaultOn || false
        }
    })

</script>
</body>
</html>